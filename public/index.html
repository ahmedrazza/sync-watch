<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>SyncWatch: Production Ready</title>
		<style>
			body {
				font-family: 'Segoe UI', sans-serif;
				background: #121212;
				color: #fff;
				display: flex;
				flex-direction: column;
				height: 100vh;
				margin: 0;
				overflow: hidden;
			}

			/* Navbar */
			#navbar {
				padding: 15px 20px;
				background: #1a1a1a;
				display: flex;
				gap: 10px;
				border-bottom: 1px solid #333;
				align-items: center;
			}
			#urlInput {
				flex: 1;
				padding: 12px;
				border-radius: 4px;
				border: 1px solid #333;
				background: #252525;
				color: white;
				outline: none;
			}
			button {
				padding: 10px 15px;
				cursor: pointer;
				border-radius: 4px;
				border: none;
				font-weight: bold;
				transition: 0.2s;
				font-size: 0.9em;
			}
			#loadBtn {
				background: #e50914;
				color: white;
			}

			/* Main Layout */
			#content {
				display: flex;
				flex: 1;
				height: calc(100vh - 70px);
			}

			/* Video Player */
			#video-container {
				flex: 3;
				background: black;
				display: flex;
				justify-content: center;
				align-items: center;
				position: relative;
			}
			#mainVideo {
				width: 100%;
				max-height: 100%;
				outline: none;
			}

			/* Sidebar */
			#sidebar {
				flex: 1;
				min-width: 350px;
				max-width: 400px;
				background: #1e1e1e;
				display: flex;
				flex-direction: column;
				border-left: 1px solid #333;
			}

			/* Webcam Section */
			#webcam-area {
				padding: 15px;
				background: #000;
				display: flex;
				gap: 10px;
				height: 140px;
				border-bottom: 1px solid #333;
			}
			.cam-box {
				flex: 1;
				background: #222;
				border-radius: 8px;
				overflow: hidden;
				position: relative;
				display: flex;
				justify-content: center;
				align-items: center;
				border: 1px solid #444;
			}
			.cam-box video {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1); /* Mirror effect */
			}
			.cam-label {
				position: absolute;
				bottom: 5px;
				left: 5px;
				background: rgba(0, 0, 0, 0.6);
				padding: 2px 6px;
				font-size: 0.7em;
				border-radius: 4px;
				z-index: 10;
			}

			/* Controls */
			#controls {
				padding: 15px;
				border-bottom: 1px solid #333;
				display: flex;
				gap: 10px;
				justify-content: center;
			}
			.media-btn {
				flex: 1;
				background: #333;
				color: #ccc;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 5px;
			}
			.media-btn:hover {
				background: #444;
			}
			.media-btn.active {
				background: #2ecc71;
				color: black;
			}
			.media-btn.off {
				background: #e74c3c;
				color: white;
			}

			/* Chat */
			#chat-window {
				flex: 1;
				overflow-y: auto;
				padding: 15px;
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.message {
				background: #2d2d2d;
				padding: 8px 12px;
				border-radius: 6px;
				font-size: 0.9em;
				word-wrap: break-word;
			}
			.name-tag {
				font-weight: bold;
				font-size: 0.8em;
				margin-right: 5px;
			}
			.msg-text {
				color: #ddd;
			}

			#chat-input-area {
				padding: 15px;
				background: #252525;
				border-top: 1px solid #333;
			}
			#chatInput {
				width: 100%;
				padding: 12px;
				background: #333;
				border: none;
				color: white;
				border-radius: 4px;
				outline: none;
				box-sizing: border-box;
			}

			#status-msg {
				position: absolute;
				top: 20px;
				background: rgba(0, 0, 0, 0.7);
				padding: 8px 16px;
				border-radius: 20px;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.5s;
			}
		</style>
	</head>
	<body>
		<div id="navbar">
			<input
				type="text"
				id="urlInput"
				placeholder="Paste Cloudflare MP4 Link..."
			/>
			<button
				id="loadBtn"
				onclick="loadVideo()"
			>
				Load Movie
			</button>
		</div>

		<div id="content">
			<div id="video-container">
				<div id="status-msg">Synced</div>
				<video
					id="mainVideo"
					controls
				></video>
			</div>

			<div id="sidebar">
				<div id="webcam-area">
					<div class="cam-box">
						<video
							id="localVideo"
							muted
							autoplay
							playsinline
						></video>
						<div class="cam-label">You</div>
					</div>
					<div class="cam-box">
						<video
							id="remoteVideo"
							autoplay
							playsinline
						></video>
						<div class="cam-label">Friend</div>
					</div>
				</div>

				<div id="controls">
					<button
						id="joinBtn"
						style="width: 100%; background: #007bff"
						onclick="startCall()"
					>
						ðŸ“ž Join Call
					</button>
					<button
						id="camBtn"
						class="media-btn active"
						style="display: none"
						onclick="toggleVideo()"
					>
						ðŸŽ¥ Cam On
					</button>
					<button
						id="micBtn"
						class="media-btn active"
						style="display: none"
						onclick="toggleAudio()"
					>
						ðŸŽ¤ Mic On
					</button>
				</div>

				<div id="chat-window"></div>

				<div id="chat-input-area">
					<input
						type="text"
						id="chatInput"
						placeholder="Type a message..."
						onkeypress="handleChat(event)"
					/>
				</div>
			</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
		<script>
			const socket = io();
			let myName = prompt('Enter your name:', 'Guest') || 'Guest';

			// --- 1. PEERJS CONFIGURATION (THE FIREWALL FIX) ---
			// We added "iceServers" which are free Google servers to punch through firewalls
			const myPeer = new Peer(undefined, {
				path: '/peerjs',
				host: '/',
				port: location.port || (location.protocol === 'https:' ? 443 : 80),
				config: {
					iceServers: [
						{ url: 'stun:stun.l.google.com:19302' },
						{ url: 'stun:stun1.l.google.com:19302' },
						{ url: 'stun:stun2.l.google.com:19302' },
					],
				},
			});

			// --- 2. WEBCAM LOGIC ---
			let localStream;
			const localVideo = document.getElementById('localVideo');
			const remoteVideo = document.getElementById('remoteVideo');
			const joinBtn = document.getElementById('joinBtn');
			const camBtn = document.getElementById('camBtn');
			const micBtn = document.getElementById('micBtn');

			// Initial setup to handle incoming calls
			myPeer.on('call', (call) => {
				call.answer(localStream);
				call.on('stream', (userVideoStream) => {
					remoteVideo.srcObject = userVideoStream;
				});
			});

			socket.on('user-connected', (peerId) => {
				if (localStream) connectToNewUser(peerId, localStream);
			});

			myPeer.on('open', (id) => {
				console.log('My Peer ID:', id);
			});

			// A. Start the connection
			function startCall() {
				navigator.mediaDevices
					.getUserMedia({ audio: true, video: true })
					.then((stream) => {
						localStream = stream;
						localVideo.srcObject = stream;

						// Show controls, hide join button
						joinBtn.style.display = 'none';
						camBtn.style.display = 'flex';
						micBtn.style.display = 'flex';

						// Connect to server
						socket.emit('join-room', myPeer.id);
					})
					.catch((err) => {
						alert('Please allow Camera/Mic access. Error: ' + err);
					});
			}

			// B. Toggle Camera
			function toggleVideo() {
				if (!localStream) return;
				const videoTrack = localStream.getVideoTracks()[0];
				if (videoTrack.enabled) {
					videoTrack.enabled = false;
					camBtn.innerText = 'ðŸ“· Cam Off';
					camBtn.classList.remove('active');
					camBtn.classList.add('off');
				} else {
					videoTrack.enabled = true;
					camBtn.innerText = 'ðŸŽ¥ Cam On';
					camBtn.classList.remove('off');
					camBtn.classList.add('active');
				}
			}

			// C. Toggle Mic
			function toggleAudio() {
				if (!localStream) return;
				const audioTrack = localStream.getAudioTracks()[0];
				if (audioTrack.enabled) {
					audioTrack.enabled = false;
					micBtn.innerText = 'ðŸ”‡ Mic Off';
					micBtn.classList.remove('active');
					micBtn.classList.add('off');
				} else {
					audioTrack.enabled = true;
					micBtn.innerText = 'ðŸŽ¤ Mic On';
					micBtn.classList.remove('off');
					micBtn.classList.add('active');
				}
			}

			function connectToNewUser(peerId, stream) {
				const call = myPeer.call(peerId, stream);
				call.on('stream', (userVideoStream) => {
					remoteVideo.srcObject = userVideoStream;
				});
			}

			// --- 3. MOVIE SYNC ---
			const video = document.getElementById('mainVideo');
			const urlInput = document.getElementById('urlInput');
			const statusMsg = document.getElementById('status-msg');
			let isSyncing = false;

			function loadVideo() {
				let url = urlInput.value.trim();
				if (url.includes('<iframe')) {
					const match = url.match(/src="([^"]+)"/);
					if (match && match[1]) url = match[1];
				}
				if (url) socket.emit('change-video', url);
			}

			socket.on('update-video', (url) => {
				video.src = url;
				urlInput.value = url;
				showStatus('Video Loaded');
			});

			video.onplay = () => {
				if (!isSyncing) emitAction('play');
			};
			video.onpause = () => {
				if (!isSyncing) emitAction('pause');
			};
			video.onseeked = () => {
				if (!isSyncing) emitAction('seek');
			};

			function emitAction(type) {
				socket.emit('sync-action', { type, time: video.currentTime });
			}

			socket.on('sync-action', (data) => {
				isSyncing = true;
				if (Math.abs(video.currentTime - data.time) > 0.5)
					video.currentTime = data.time;
				if (data.type === 'play') {
					video.play().catch(() => {});
					showStatus('Playing');
				} else if (data.type === 'pause') {
					video.pause();
					showStatus('Paused');
				}
				setTimeout(() => {
					isSyncing = false;
				}, 300);
			});

			function showStatus(msg) {
				statusMsg.innerText = msg;
				statusMsg.style.opacity = 1;
				setTimeout(() => (statusMsg.style.opacity = 0), 1500);
			}

			// --- 4. CHAT ---
			const chatWindow = document.getElementById('chat-window');
			function handleChat(e) {
				if (e.key === 'Enter') {
					const input = document.getElementById('chatInput');
					if (input.value.trim()) {
						socket.emit('chat-message', { user: myName, text: input.value });
						input.value = '';
					}
				}
			}
			socket.on('chat-message', (data) => {
				const div = document.createElement('div');
				div.className = 'message';
				const color = data.user === myName ? '#2ecc71' : '#3498db';
				div.innerHTML = `<span class="name-tag" style="color:${color}">${data.user}:</span> <span class="msg-text">${data.text}</span>`;
				chatWindow.appendChild(div);
				chatWindow.scrollTop = chatWindow.scrollHeight;
			});

			// --- 5. HEARTBEAT ---
			setInterval(
				() => {
					if (socket.connected) socket.emit('heartbeat');
				},
				5 * 60 * 1000,
			);
		</script>
	</body>
</html>
