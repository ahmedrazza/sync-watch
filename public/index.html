<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>SyncWatch: Stable</title>
		<style>
			/* Base Reset */
			body {
				font-family: 'Segoe UI', sans-serif;
				background: #000;
				color: #fff;
				display: flex;
				flex-direction: column;
				height: 100vh;
				margin: 0;
				overflow: hidden;
			}

			#navbar {
				padding: 10px;
				background: #1a1a1a;
				display: flex;
				gap: 8px;
				border-bottom: 1px solid #333;
				z-index: 10;
			}
			#urlInput {
				flex: 1;
				padding: 10px;
				border-radius: 4px;
				border: 1px solid #333;
				background: #252525;
				color: white;
				outline: none;
				font-size: 16px;
			}
			#loadBtn {
				padding: 10px 15px;
				background: #e50914;
				color: white;
				border: none;
				border-radius: 4px;
				font-weight: bold;
				white-space: nowrap;
			}

			#content {
				display: flex;
				flex: 1;
				height: calc(100vh - 60px);
			}

			#video-container {
				flex: 3;
				background: #000;
				display: flex;
				justify-content: center;
				align-items: center;
				position: relative;
				min-width: 0;
			}
			/* Reliable CSS for Raw Player */
			#mainVideo {
				width: 100%;
				height: 100%;
				object-fit: contain;
				outline: none;
			}

			#sidebar {
				flex: 1;
				min-width: 300px;
				max-width: 350px;
				background: #1e1e1e;
				display: flex;
				flex-direction: column;
				border-left: 1px solid #333;
			}

			@media (max-width: 768px) {
				#content {
					flex-direction: column;
					overflow-y: auto;
				}
				#video-container {
					flex: none;
					height: 40vh;
					width: 100%;
				}
				#sidebar {
					flex: none;
					width: 100%;
					max-width: none;
					min-width: 0;
					height: auto;
				}
				#webcam-area {
					height: 120px;
				}
			}

			#webcam-area {
				padding: 10px;
				background: #111;
				display: flex;
				gap: 5px;
				height: 140px;
				border-bottom: 1px solid #333;
			}
			.cam-box {
				flex: 1;
				background: #222;
				border-radius: 6px;
				overflow: hidden;
				position: relative;
				border: 1px solid #444;
			}

			/* Mirror Local, Normal Remote */
			#localVideo {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1);
			}
			#remoteVideo {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.cam-label {
				position: absolute;
				bottom: 4px;
				left: 4px;
				background: rgba(0, 0, 0, 0.7);
				padding: 2px 5px;
				font-size: 0.7em;
				border-radius: 3px;
				z-index: 5;
			}

			/* The Red Audio Fix Overlay */
			#unmuteOverlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(192, 57, 43, 0.9);
				display: none;
				justify-content: center;
				align-items: center;
				cursor: pointer;
				z-index: 10;
				flex-direction: column;
				text-align: center;
			}
			#unmuteOverlay span {
				font-weight: bold;
				font-size: 0.9em;
				padding: 5px;
			}

			#controls {
				padding: 10px;
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8px;
				border-bottom: 1px solid #333;
			}
			.btn-join {
				grid-column: span 2;
				background: #007bff;
				color: white;
				padding: 15px;
				border: none;
				border-radius: 4px;
				font-weight: bold;
				font-size: 1.1rem;
			}
			.btn-toggle {
				padding: 12px;
				border: none;
				border-radius: 4px;
				font-weight: bold;
				cursor: pointer;
				display: none;
			}
			.btn-on {
				background: #2ecc71;
				color: #000;
			}
			.btn-off {
				background: #e74c3c;
				color: #fff;
			}

			#chat-window {
				flex: 1;
				min-height: 200px;
				overflow-y: auto;
				padding: 10px;
				display: flex;
				flex-direction: column;
				gap: 8px;
				background: #1a1a1a;
			}
			.message {
				background: #2d2d2d;
				padding: 8px 10px;
				border-radius: 6px;
				font-size: 0.9em;
				word-wrap: break-word;
			}
			#chat-input-area {
				padding: 10px;
				background: #222;
				border-top: 1px solid #333;
			}
			#chatInput {
				width: 100%;
				padding: 12px;
				background: #333;
				border: none;
				color: white;
				border-radius: 4px;
				box-sizing: border-box;
			}

			#status-msg {
				position: absolute;
				top: 10px;
				right: 10px;
				background: rgba(0, 0, 0, 0.8);
				padding: 5px 15px;
				border-radius: 20px;
				font-size: 0.8em;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.5s;
				z-index: 20;
			}
		</style>
	</head>
	<body>
		<div id="navbar">
			<input
				type="text"
				id="urlInput"
				placeholder="Paste Cloudflare MP4 Link"
			/>
			<button
				id="loadBtn"
				onclick="loadVideo()"
			>
				Load
			</button>
		</div>

		<div id="content">
			<div id="video-container">
				<div id="status-msg">Synced</div>
				<video
					id="mainVideo"
					controls
					playsinline
					preload="auto"
				></video>
			</div>

			<div id="sidebar">
				<div id="webcam-area">
					<div class="cam-box">
						<video
							id="localVideo"
							muted
							autoplay
							playsinline
						></video>
						<div class="cam-label">You</div>
					</div>
					<div class="cam-box">
						<div
							id="unmuteOverlay"
							onclick="fixAudio()"
						>
							<span>ðŸ”‡ Sound Blocked</span>
							<span style="font-size: 0.8em; opacity: 0.8"
								>Tap to Hear Friend</span
							>
						</div>
						<video
							id="remoteVideo"
							autoplay
							playsinline
						></video>
						<div class="cam-label">Friend</div>
					</div>
				</div>

				<div id="controls">
					<button
						id="joinBtn"
						class="btn-join"
						onclick="joinCall()"
					>
						ðŸ“ž Join Audio/Video
					</button>
					<button
						id="camToggle"
						class="btn-toggle btn-on"
						onclick="toggleCam()"
					>
						ðŸŽ¥ Cam ON
					</button>
					<button
						id="micToggle"
						class="btn-toggle btn-on"
						onclick="toggleMic()"
					>
						ðŸŽ¤ Mic ON
					</button>
				</div>

				<div id="chat-window"></div>
				<div id="chat-input-area">
					<input
						type="text"
						id="chatInput"
						placeholder="Chat..."
						onkeypress="handleChat(event)"
					/>
				</div>
			</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
		<script>
			const socket = io();
			const myName = 'User ' + Math.floor(Math.random() * 1000);

			// --- PEERJS CONFIG ---
			const myPeer = new Peer(undefined, {
				path: '/peerjs',
				host: '/',
				port: location.port || (location.protocol === 'https:' ? 443 : 80),
				config: {
					iceServers: [
						{ url: 'stun:stun.l.google.com:19302' },
						{ url: 'stun:stun1.l.google.com:19302' },
					],
				},
			});

			let localStream = null;
			const joinBtn = document.getElementById('joinBtn');
			const camToggle = document.getElementById('camToggle');
			const micToggle = document.getElementById('micToggle');
			const localVideo = document.getElementById('localVideo');
			const remoteVideo = document.getElementById('remoteVideo');
			const unmuteOverlay = document.getElementById('unmuteOverlay');

			function joinCall() {
				// Low Resolution for Fast Mobile Loading
				const constraints = {
					audio: true,
					video: {
						width: { ideal: 320 },
						height: { ideal: 240 },
						frameRate: { ideal: 15 },
					},
				};

				navigator.mediaDevices
					.getUserMedia(constraints)
					.then((stream) => {
						localStream = stream;
						localVideo.srcObject = stream;
						joinBtn.style.display = 'none';
						camToggle.style.display = 'block';
						micToggle.style.display = 'block';
						socket.emit('join-room', myPeer.id);
					})
					.catch((err) => alert('Error: ' + err));
			}

			function handleIncomingStream(stream) {
				remoteVideo.srcObject = stream;
				// Force Audio ON
				remoteVideo.muted = false;
				remoteVideo.volume = 1.0;
				remoteVideo.playsInline = true;

				const playPromise = remoteVideo.play();
				if (playPromise !== undefined) {
					playPromise.catch((error) => {
						// If browser blocks audio, show RED BUTTON
						unmuteOverlay.style.display = 'flex';
					});
				}
			}

			function fixAudio() {
				remoteVideo.play();
				remoteVideo.muted = false;
				remoteVideo.volume = 1.0;
				unmuteOverlay.style.display = 'none';
			}

			myPeer.on('call', (call) => {
				call.answer(localStream);
				call.on('stream', (stream) => handleIncomingStream(stream));
			});

			socket.on('user-connected', (peerId) => {
				if (localStream) {
					const call = myPeer.call(peerId, localStream);
					call.on('stream', (stream) => handleIncomingStream(stream));
				}
			});

			function toggleCam() {
				if (!localStream) return;
				const track = localStream.getVideoTracks()[0];
				track.enabled = !track.enabled;
				camToggle.innerText = track.enabled ? 'ðŸŽ¥ Cam ON' : 'ðŸ“· Cam OFF';
				camToggle.className = track.enabled
					? 'btn-toggle btn-on'
					: 'btn-toggle btn-off';
			}

			function toggleMic() {
				if (!localStream) return;
				const track = localStream.getAudioTracks()[0];
				track.enabled = !track.enabled;
				micToggle.innerText = track.enabled ? 'ðŸŽ¤ Mic ON' : 'ðŸ”‡ Mic OFF';
				micToggle.className = track.enabled
					? 'btn-toggle btn-on'
					: 'btn-toggle btn-off';
			}

			// --- MOVIE SYNC ---
			const video = document.getElementById('mainVideo');
			const urlInput = document.getElementById('urlInput');
			const statusMsg = document.getElementById('status-msg');
			let isSyncing = false;

			function loadVideo() {
				let url = urlInput.value.trim();
				if (url.includes('<iframe')) {
					const match = url.match(/src="([^"]+)"/);
					if (match && match[1]) url = match[1];
				}
				if (url) socket.emit('change-video', url);
			}

			socket.on('update-video', (url) => {
				video.src = url;
				urlInput.value = url;
				showStatus('Loaded');
			});

			video.onplay = () => {
				if (!isSyncing) emitAction('play');
			};
			video.onpause = () => {
				if (!isSyncing) emitAction('pause');
			};
			video.onseeked = () => {
				if (!isSyncing) emitAction('seek');
			};

			function emitAction(type) {
				socket.emit('sync-action', { type, time: video.currentTime });
			}

			socket.on('sync-action', (data) => {
				isSyncing = true;
				if (Math.abs(video.currentTime - data.time) > 0.5)
					video.currentTime = data.time;

				if (data.type === 'play') {
					video.play().catch(() => {});
					showStatus('Playing');
				} else if (data.type === 'pause') {
					video.pause();
					showStatus('Paused');
				}
				setTimeout(() => (isSyncing = false), 300);
			});

			function showStatus(msg) {
				statusMsg.innerText = msg;
				statusMsg.style.opacity = 1;
				setTimeout(() => (statusMsg.style.opacity = 0), 1500);
			}

			const chatWindow = document.getElementById('chat-window');
			function handleChat(e) {
				if (e.key === 'Enter') {
					const input = document.getElementById('chatInput');
					if (input.value.trim()) {
						socket.emit('chat-message', { user: myName, text: input.value });
						input.value = '';
					}
				}
			}
			socket.on('chat-message', (data) => {
				const div = document.createElement('div');
				div.className = 'message';
				const color = data.user === myName ? '#2ecc71' : '#3498db';
				div.innerHTML = `<strong style="color:${color}">${data.user}:</strong> ${data.text}`;
				chatWindow.appendChild(div);
				chatWindow.scrollTop = chatWindow.scrollHeight;
			});

			setInterval(
				() => {
					if (socket.connected) socket.emit('heartbeat');
				},
				5 * 60 * 1000,
			);
		</script>
	</body>
</html>
